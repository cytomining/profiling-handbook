
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>5. Create Profiles &#8212; Image-based Profiling Handbook</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Appendix" href="06-appendix.html" />
    <link rel="prev" title="4. Run each CellProfiler step" href="04-run-cellprofiler.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Image-based Profiling Handbook</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Preface
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01-overview.html">
   1. Introduction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Configuration
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="02-config.html">
   2. Configure Environment for Full Profiling Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-setup-images.html">
   3. Setup Images
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04-run-cellprofiler.html">
   4. Run each CellProfiler step
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   5. Create Profiles
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="06-appendix.html">
   Appendix
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/cytomining/profiling-handbook"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/cytomining/profiling-handbook/edit/master/05-create-profiles.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/05-create-profiles.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#confirm-environment-configuration">
   5.1. Confirm Environment Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-a-large-ebs-volume-to-your-machine">
   5.2. Add a large EBS volume to your machine
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-database-backend">
   5.3. Create Database Backend
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-metadata-files">
   5.4. Create Metadata Files
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-github">
   5.5. Set up GitHub
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-profiles">
   5.6. Make Profiles
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-set-up-compute-environment">
     5.6.1. Optional - set up compute environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-new-environment-variables">
     5.6.2. Set new environment variables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-compute-environment-make-some-directories">
     5.6.3. If a first batch in this compute environment, make some directories
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-your-backend-files">
     5.6.4. Add your backend files
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-compute-environment-clone-your-repository">
     5.6.5. If a first batch in this compute environment, clone your repository
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-project-weld-the-recipe-into-the-repository">
     5.6.6. If a first batch in this project, weld the recipe into the repository
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-compute-environment-set-up-the-environment">
     5.6.7. If a first batch in this compute environment, set up the environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#activate-the-environment">
     5.6.8. Activate the environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-dvc">
     5.6.9. Set up DVC
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-project-create-the-necessary-directories">
     5.6.10. If a first batch in this project, create the necessary directories
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-load-data-csvs">
     5.6.11. Download the load_data_CSVs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-metadata-files">
     5.6.12. Download the metadata files
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#make-the-config-file">
     5.6.13. Make the config file
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-the-profiles">
     5.6.14. Set up the profiles
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-profiling-workflow">
     5.6.15. Run the profiling workflow
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#push-resulting-files-back-up-to-github">
     5.6.16. Push resulting files back up to GitHub
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#push-resulting-files-up-to-s3">
     5.6.17. Push resulting files up to S3
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Create Profiles</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#confirm-environment-configuration">
   5.1. Confirm Environment Configuration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-a-large-ebs-volume-to-your-machine">
   5.2. Add a large EBS volume to your machine
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-database-backend">
   5.3. Create Database Backend
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-metadata-files">
   5.4. Create Metadata Files
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-github">
   5.5. Set up GitHub
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-profiles">
   5.6. Make Profiles
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-set-up-compute-environment">
     5.6.1. Optional - set up compute environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-new-environment-variables">
     5.6.2. Set new environment variables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-compute-environment-make-some-directories">
     5.6.3. If a first batch in this compute environment, make some directories
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-your-backend-files">
     5.6.4. Add your backend files
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-compute-environment-clone-your-repository">
     5.6.5. If a first batch in this compute environment, clone your repository
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-project-weld-the-recipe-into-the-repository">
     5.6.6. If a first batch in this project, weld the recipe into the repository
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-compute-environment-set-up-the-environment">
     5.6.7. If a first batch in this compute environment, set up the environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#activate-the-environment">
     5.6.8. Activate the environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-dvc">
     5.6.9. Set up DVC
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#if-a-first-batch-in-this-project-create-the-necessary-directories">
     5.6.10. If a first batch in this project, create the necessary directories
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-load-data-csvs">
     5.6.11. Download the load_data_CSVs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-metadata-files">
     5.6.12. Download the metadata files
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#make-the-config-file">
     5.6.13. Make the config file
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-the-profiles">
     5.6.14. Set up the profiles
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-profiling-workflow">
     5.6.15. Run the profiling workflow
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#push-resulting-files-back-up-to-github">
     5.6.16. Push resulting files back up to GitHub
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#push-resulting-files-up-to-s3">
     5.6.17. Push resulting files up to S3
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="create-profiles">
<h1><span class="section-number">5. </span>Create Profiles<a class="headerlink" href="#create-profiles" title="Permalink to this headline">#</a></h1>
<section id="confirm-environment-configuration">
<h2><span class="section-number">5.1. </span>Confirm Environment Configuration<a class="headerlink" href="#confirm-environment-configuration" title="Permalink to this headline">#</a></h2>
<p>You CAN, if you choose, make your backends with the same machine that you have used to make CSVs and run DCP for CellProfiler.  However, we typically do not, since backend creation can take a long time so it is desirable to use 2 machines - a small inexpensive machine with only a few CPUs for all the steps before backends and a larger machine with at least as many CPUs as (the number of plates in your batch +1) for backend creation. Both machines can be turned off when not in use and when off will generate only minimal charges.</p>
<p>To make a new backend machine, follow the identical instructions as in the section below, only with a larger Instance Type (such as an m4.10xlarge).</p>
<ul class="simple">
<li><p><a class="reference internal" href="02-config.html#config-aws"><span class="std std-ref">Launch an AWS Virtual Machine for making CSVs and running Distributed-CellProfiler</span></a></p></li>
</ul>
<p>Since backend creation also typically requires a large amount of hard disk space, which you pay for whether or not the machine is on, we recommend attaching a large EBS volume to your backend creation machine only when needed, then detaching and terminating it when not in use.</p>
</section>
<section id="add-a-large-ebs-volume-to-your-machine">
<h2><span class="section-number">5.2. </span>Add a large EBS volume to your machine<a class="headerlink" href="#add-a-large-ebs-volume-to-your-machine" title="Permalink to this headline">#</a></h2>
<p>Follow the AWS instructions for <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-volume.html">creating</a> and <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-attaching-volume.html">attaching</a> the EBS volume. Two critical factors to note- the volume must be created in the same subnet as your backend creation machine, and should be approximately 2X the size as the analysis files in your batch - this is most easily figured by navigating to that location in the S3 web console and selecting “Actions -&gt; Calculate total size”.</p>
<p>Once the volume is created and attached, ensure the machine is started and SSH connect to it.</p>
<p>Create a temp directory which is required when creating the database backed using <code class="docutils literal notranslate"><span class="pre">cytominer-database</span></code> (discussed later).</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir ~/ebs_tmp
</pre></div>
</div>
<p>Get the name of the disk and attach it.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># check the name of the disk</span>
lsblk

<span class="c1">#&gt; NAME    MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span>
<span class="c1">#&gt; xvda    202:0    0     8G  0 disk</span>
<span class="c1">#&gt; └─xvda1 202:1    0     8G  0 part /</span>
<span class="c1">#&gt; xvdba    202:80   0   100G  0 disk</span>

<span class="c1"># check if it has a file system</span>
sudo file -s /dev/xvdba
<span class="c1"># ...likely not, in which case you get:</span>
<span class="c1">#&gt; /dev/xvdf: data</span>

<span class="c1"># if no file system, then create it</span>
sudo mkfs -t ext4 /dev/xvdba

<span class="c1"># mount it</span>
sudo mount /dev/xvdba /home/ubuntu/ebs_tmp/

<span class="c1"># change perm</span>
sudo chmod <span class="m">777</span> ~/ebs_tmp/
</pre></div>
</div>
<p>If you are starting from here, make sure the following steps have been completed on your ec2 instance and/or session before proceeding</p>
<ul class="simple">
<li><p><a class="reference internal" href="02-config.html"><span class="doc std std-doc">Configure Environment for Full Profiling Pipeline</span></a></p></li>
<li><p><a class="reference internal" href="03-setup-images.html#setup-images-create-plates"><span class="std std-ref">Create list of plates</span></a></p></li>
</ul>
</section>
<section id="create-database-backend">
<h2><span class="section-number">5.3. </span>Create Database Backend<a class="headerlink" href="#create-database-backend" title="Permalink to this headline">#</a></h2>
<p>Run creation of sqlite backend as well as aggregation of measurements into per-well profiles. This process can be very slow since the files are read from s3fs/EFS. We recommend first downloading the CSVs files locally on an EBS volume attached to the ec2 instance you are running on, and then ingesting.</p>
<p>To do so, first recreate the analysis output folder structure on the EBS volume:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir -p ~/ebs_tmp/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>/workspace/software

<span class="nb">cd</span> ~/ebs_tmp/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>/workspace/software

<span class="k">if</span> <span class="o">[</span> -d pycytominer <span class="o">]</span><span class="p">;</span> <span class="k">then</span> rm -rf pycytominer<span class="p">;</span> <span class="k">fi</span>

git clone https://github.com/cytomining/pycytominer.git

<span class="nb">cd</span> pycytominer

python3 -m pip install -e .
</pre></div>
</div>
<p>Note that if your system does not already have <code class="docutils literal notranslate"><span class="pre">cytominer-database</span></code> installed, you can install it at the same time as pycytominer by changing the final command above to <code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">-m</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span> <span class="pre">.[collate]</span></code></p>
<p>The command below first calls <code class="docutils literal notranslate"><span class="pre">cytominer-database</span> <span class="pre">ingest</span></code> to create the SQLite backend, and then pycytominer’s <code class="docutils literal notranslate"><span class="pre">aggregate_profiles</span></code> to create per-well profiles. Once complete, all files are uploaded to S3 and the local cache are deleted. This step takes several hours, but metadata creation and GitHub setup can be done in this time.</p>
<p><a class="reference external" href="https://github.com/cytomining/pycytominer/blob/jump/pycytominer/cyto_utils/collate.py">collate.py</a> ingests and indexes the database.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pyenv shell <span class="m">3</span>.8.10

mkdir -p  ../../log/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span>/
parallel <span class="se">\</span>
--max-procs <span class="si">${</span><span class="nv">MAXPROCS</span><span class="si">}</span> <span class="se">\</span>
--ungroup <span class="se">\</span>
--eta <span class="se">\</span>
--joblog ../../log/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span>/collate.log <span class="se">\</span>
--results ../../log/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span>/collate <span class="se">\</span>
--files <span class="se">\</span>
--keep-order <span class="se">\</span>
python3 pycytominer/cyto_utils/collate.py <span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span>  pycytominer/cyto_utils/ingest_config.ini <span class="o">{</span><span class="m">1</span><span class="o">}</span> <span class="se">\</span>
--tmp-dir ~/ebs_tmp <span class="se">\</span>
--remote<span class="o">=</span>s3://<span class="si">${</span><span class="nv">BUCKET</span><span class="si">}</span>/projects/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>/workspace :::: <span class="si">${</span><span class="nv">PLATES</span><span class="si">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">collate.py</span></code> does not recreate the SQLite backend if it already exists in the local cache. Add <code class="docutils literal notranslate"><span class="pre">--overwrite</span></code> flag to recreate.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>or pipelines that use FlagImage to skip the measurements modules if the image failed QC, the failed images will have Image.csv files with fewer columns that the rest (because columns corresponding to aggregated measurements will be absent). The ingest command will show a warning related to sqlite: <code class="docutils literal notranslate"><span class="pre">expected</span> <span class="pre">X</span> <span class="pre">columns</span> <span class="pre">but</span> <span class="pre">found</span> <span class="pre">Y</span> <span class="pre">-</span> <span class="pre">filling</span> <span class="pre">the</span> <span class="pre">rest</span> <span class="pre">with</span> <span class="pre">NULL</span></code>. This is expected behavior.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is a known <a class="reference external" href="https://github.com/cytomining/cytominer-database/issues/100">issue</a> where if the alphabetically-first CSV failed QC in a pipeline where “Skip image if flagged” is turned on, the databases will not be created. We are working to fix this, but in the meantime we recommend either not skipping processing of your flagged images (and removing them from your data downstream) or deleting the alphabetically-first CSVs until you come to one where the pipeline ran completely.</p>
</div>
<p>This is the resulting structure of <code class="docutils literal notranslate"><span class="pre">backend</span></code> on S3 (one level below <code class="docutils literal notranslate"><span class="pre">workspace</span></code>) for <code class="docutils literal notranslate"><span class="pre">SQ00015167</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>└── backend
    └── 2016_04_01_a549_48hr_batch1
        └── SQ00015167
            ├── SQ00015167.csv
            └── SQ00015167.sqlite
</pre></div>
</div>
<p>At this point, the user needs to use the <a class="reference external" href="https://github.com/cytomining/profiling-template">profiling template</a> to use <a class="reference external" href="https://github.com/cytomining/pycytominer/">pycytominer</a> to annotate the profiles with metadata, normalize them, and feature select them.</p>
</section>
<section id="create-metadata-files">
<h2><span class="section-number">5.4. </span>Create Metadata Files<a class="headerlink" href="#create-metadata-files" title="Permalink to this headline">#</a></h2>
<p>First, get metadata for the plates. This should be created beforehand and uploaded into S3.</p>
<p>This is the structure of the metadata folder (one level below <code class="docutils literal notranslate"><span class="pre">workspace</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>└── metadata
    └── platemaps
        └── 2016_04_01_a549_48hr_batch1
            ├── barcode_platemap.csv
            └── platemap
                └── C-7161-01-LM6-006.txt
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">2016_04_01_a549_48hr_batch1</span></code> is the batch name – the plates (and all related data) are arranged under batches, as seen below.</p>
<p><code class="docutils literal notranslate"><span class="pre">barcode_platemap.csv</span></code> is structured as shown below. <code class="docutils literal notranslate"><span class="pre">Assay_Plate_Barcode</span></code> and <code class="docutils literal notranslate"><span class="pre">Plate_Map_Name</span></code> are currently the only mandatory columns (they are used to join the metadata of the plate map with each assay plate). Each unique entry in the <code class="docutils literal notranslate"><span class="pre">Plate_Map_Name</span></code> should have a corresponding tab-separated file <code class="docutils literal notranslate"><span class="pre">.txt</span></code> file under <code class="docutils literal notranslate"><span class="pre">platemap</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">C-7161-01-LM6-006.txt</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Assay_Plate_Barcode</span><span class="p">,</span><span class="n">Plate_Map_Name</span>
<span class="n">SQ00015167</span><span class="p">,</span><span class="n">C</span><span class="o">-</span><span class="mi">7161</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">LM6</span><span class="o">-</span><span class="mi">006</span>
</pre></div>
</div>
<p>The tab-separated files are plate maps and are structured like this:
(This is the typical format followed by Broad Chemical Biology Platform)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plate_map_name</span>  <span class="n">well_position</span> <span class="n">broad_sample</span>  <span class="n">mg_per_ml</span> <span class="n">mmoles_per_liter</span>  <span class="n">solvent</span>
<span class="n">C</span><span class="o">-</span><span class="mi">7161</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">LM6</span><span class="o">-</span><span class="mi">006</span> <span class="n">A07</span> <span class="n">BRD</span><span class="o">-</span><span class="n">K18895904</span><span class="o">-</span><span class="mi">001</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span>  <span class="mf">3.12432000000000016</span> <span class="mf">9.99999999999999999</span> <span class="n">DMSO</span>
<span class="n">C</span><span class="o">-</span><span class="mi">7161</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">LM6</span><span class="o">-</span><span class="mi">006</span> <span class="n">A08</span> <span class="n">BRD</span><span class="o">-</span><span class="n">K18895904</span><span class="o">-</span><span class="mi">001</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span>  <span class="mf">1.04143999999919895</span> <span class="mf">3.33333333333076923</span> <span class="n">DMSO</span>
<span class="n">C</span><span class="o">-</span><span class="mi">7161</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="n">LM6</span><span class="o">-</span><span class="mi">006</span> <span class="n">A09</span> <span class="n">BRD</span><span class="o">-</span><span class="n">K18895904</span><span class="o">-</span><span class="mi">001</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">1</span>  <span class="mf">0.347146666668001866</span>  <span class="mf">1.11111111111538462</span> <span class="n">DMSO</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">plate_map_name</span></code> should be identical to the name of the file (without extension).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">plate_map_name</span></code> and <code class="docutils literal notranslate"><span class="pre">well_position</span></code> are currently the only mandatory columns.</p></li>
</ul>
</div>
<p>The external metadata is an optional file tab separated <code class="docutils literal notranslate"><span class="pre">.tsv</span></code> file that contains the mapping between a perturbation identifier to other metadata. The name of the perturbation identifier column (e.g. <code class="docutils literal notranslate"><span class="pre">broad_sample</span></code>) should be the same as the column in platemap.txt.</p>
<p>The external metadata file should be placed in a folder named <code class="docutils literal notranslate"><span class="pre">external_metadata</span></code> within the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> folder. If this file is provided, then the following should be the folder structure</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>└── metadata
    ├── external_metadata
    │   └── external_metadata.tsv
    └── platemaps
        └── 2016_04_01_a549_48hr_batch1
            ├── barcode_platemap.csv
            └── platemap
                └── C-7161-01-LM6-006.txt
</pre></div>
</div>
</section>
<section id="set-up-github">
<h2><span class="section-number">5.5. </span>Set up GitHub<a class="headerlink" href="#set-up-github" title="Permalink to this headline">#</a></h2>
<p>Once and only once - fork the <a class="reference external" href="https://github.com/cytomining/profiling-recipe">profiling recipe</a> to your own user name
(Each time you make a new project - you may want to <a class="reference external" href="https://docs.github.com/en/github/collaborating-with-pull-requests/working-with-forks/syncing-a-fork">keep your fork up to date</a></p>
<p>Once per new PROJECT, not new batch - make a copy of the <a class="reference external" href="https://github.com/cytomining/profiling-template">template repository</a> into your preferred organization with a project name that is similar OR identical to its project tag on S3 and elsewhere.</p>
<p>Once per new PROJECT, not new batch - make a copy of the <a class="reference external" href="https://github.com/cytomining/profiling-template">template repository</a> into your preferred organization with a project name that is similar OR identical to its project tag on S3 and elsewhere.</p>
</section>
<section id="make-profiles">
<h2><span class="section-number">5.6. </span>Make Profiles<a class="headerlink" href="#make-profiles" title="Permalink to this headline">#</a></h2>
<section id="optional-set-up-compute-environment">
<h3><span class="section-number">5.6.1. </span>Optional - set up compute environment<a class="headerlink" href="#optional-set-up-compute-environment" title="Permalink to this headline">#</a></h3>
<p>These final steps are small and can be done either in your local environment or on your node used to build the backends.
Conda is currently required and not currently on the backend creation VMs.
Use these commands to install Miniconda for a Linux ecosystem (otherwise, search for your own OS).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Miniconda installation
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh
bash ~/miniconda.sh -b -p $HOME/miniconda
export PATH=&quot;/home/ubuntu/miniconda/bin:$PATH&quot;
source .bashrc
conda init bash
source .bashrc
</pre></div>
</div>
<p>We recommend using DVC for large file management and DVC requires the use of AWS CLI.
AWS CLI is already on the backend creation VMs.
If you are not using the backend creation VM, use these commands to install AWS CLI for a Linux ecosystem (otherwise, search for your own OS).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># AWS CLI installation - if not on your machine already</span>
<span class="n">curl</span> <span class="s2">&quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot;</span> <span class="o">-</span><span class="n">o</span> <span class="s2">&quot;awscliv2.zip&quot;</span>
<span class="n">unzip</span> <span class="n">awscliv2</span><span class="o">.</span><span class="n">zip</span>
<span class="n">sudo</span> <span class="o">./</span><span class="n">aws</span><span class="o">/</span><span class="n">install</span>
</pre></div>
</div>
<p>Configure your AWS CLI installation with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">configure</span>
</pre></div>
</div>
<p>It will prompt you for:
<code class="docutils literal notranslate"><span class="pre">AWS</span> <span class="pre">Access</span> <span class="pre">Key</span> <span class="pre">ID:</span></code> YOUR-KEY
<code class="docutils literal notranslate"><span class="pre">AWS</span> <span class="pre">Secret</span> <span class="pre">Access</span> <span class="pre">Key:</span></code> YOUR-SECRET-KEY
<code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">region</span> <span class="pre">name:</span></code> e.g. us-east-1
<code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">output</span> <span class="pre">format:</span></code> json</p>
<p>If not using the same machine + tmux as for making backends, where your environment variables are already set, set them up</p>
<ul class="simple">
<li><p><a class="reference internal" href="02-config.html"><span class="doc std std-doc">Configure Environment for Full Profiling Pipeline</span></a></p></li>
</ul>
</section>
<section id="set-new-environment-variables">
<h3><span class="section-number">5.6.2. </span>Set new environment variables<a class="headerlink" href="#set-new-environment-variables" title="Permalink to this headline">#</a></h3>
<p>Specifically, <code class="docutils literal notranslate"><span class="pre">ORG</span></code> and <code class="docutils literal notranslate"><span class="pre">DATA</span></code> should be the GitHub organization and repository name used when creating the data repository from the template. <code class="docutils literal notranslate"><span class="pre">USER</span></code> should be your GitHub username. CONFIG_FILE will be the name of the config file used for this run, so something that makes it distinguishable (ie, batch numbers being run at this time) is helpful.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ORG</span><span class="o">=</span><span class="n">broadinstitute</span>
<span class="n">DATA</span><span class="o">=</span><span class="mi">2015_10_05</span><span class="n">_DrugRepurposing_AravindSubramanian_GolubLab_Broad</span>
<span class="n">USER</span><span class="o">=</span><span class="n">gh_username</span>
<span class="n">CONFIG_FILE</span><span class="o">=</span><span class="n">config_batch1</span>
</pre></div>
</div>
</section>
<section id="if-a-first-batch-in-this-compute-environment-make-some-directories">
<h3><span class="section-number">5.6.3. </span>If a first batch in this compute environment, make some directories<a class="headerlink" href="#if-a-first-batch-in-this-compute-environment-make-some-directories" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir -p ~/work/projects/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>/workspace/<span class="o">{</span>backend,software<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="add-your-backend-files">
<h3><span class="section-number">5.6.4. </span>Add your backend files<a class="headerlink" href="#add-your-backend-files" title="Permalink to this headline">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>aws s3 sync s3://${BUCKET}/projects/${PROJECT_NAME}/workspace/backend/${BATCH_ID} ~/work/projects/${PROJECT_NAME}/workspace/backend/${BATCH_ID} --exclude=&quot;*&quot; --include=&quot;*.csv&quot;
</pre></div>
</div>
</section>
<section id="if-a-first-batch-in-this-compute-environment-clone-your-repository">
<h3><span class="section-number">5.6.5. </span>If a first batch in this compute environment, clone your repository<a class="headerlink" href="#if-a-first-batch-in-this-compute-environment-clone-your-repository" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/work/projects/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>/workspace/software
git clone git@github.com:<span class="si">${</span><span class="nv">ORG</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATA</span><span class="si">}</span>.git
<span class="c1"># depending on your repo/machine set up you may need to provide credentials here</span>
<span class="nb">cd</span> <span class="si">${</span><span class="nv">DATA</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="if-a-first-batch-in-this-project-weld-the-recipe-into-the-repository">
<h3><span class="section-number">5.6.6. </span>If a first batch in this project, weld the recipe into the repository<a class="headerlink" href="#if-a-first-batch-in-this-project-weld-the-recipe-into-the-repository" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git submodule add https://github.com/<span class="si">${</span><span class="nv">USER</span><span class="si">}</span>/profiling-recipe.git profiling-recipe
git add profiling-recipe
git add .gitmodules
git commit -m <span class="s1">&#39;finalizing the recipe weld&#39;</span>
git push
<span class="c1"># depending on your repo/machine set up you may need to provide credentials here</span>
git submodule update --init --recursive
</pre></div>
</div>
</section>
<section id="if-a-first-batch-in-this-compute-environment-set-up-the-environment">
<h3><span class="section-number">5.6.7. </span>If a first batch in this compute environment, set up the environment<a class="headerlink" href="#if-a-first-batch-in-this-compute-environment-set-up-the-environment" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cp profiling-recipe/environment.yml .
conda env create --force --file environment.yml
</pre></div>
</div>
</section>
<section id="activate-the-environment">
<h3><span class="section-number">5.6.8. </span>Activate the environment<a class="headerlink" href="#activate-the-environment" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>conda activate profiling
</pre></div>
</div>
</section>
<section id="set-up-dvc">
<h3><span class="section-number">5.6.9. </span>Set up DVC<a class="headerlink" href="#set-up-dvc" title="Permalink to this headline">#</a></h3>
<p>Initialize DVC for this project and set it to store large files in S3.
This needs to happen once per project, not per batch.
Skip this step if not using DVC.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Navigate
cd ~/work/projects/${PROJECT_NAME}/workspace/software/${DATA}/profiling-recipe
# Initialize DVC
dvc init
# Set up remote storage
dvc remote add -d S3storage s3://${BUCKET}/projects/${PROJECT_NAME}/workspace/software/${DATA}_DVC
# Commit new files to git
git add .dvc/.gitignore .dvc/config
git commit -m &quot;Setup DVC&quot;
</pre></div>
</div>
</section>
<section id="if-a-first-batch-in-this-project-create-the-necessary-directories">
<h3><span class="section-number">5.6.10. </span>If a first batch in this project, create the necessary directories<a class="headerlink" href="#if-a-first-batch-in-this-project-create-the-necessary-directories" title="Permalink to this headline">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
### If a first batch in this project, create the necessary directories

```sh
profiling-recipe/scripts/create_dirs.sh
</pre></div>
</div>
</section>
<section id="download-the-load-data-csvs">
<h3><span class="section-number">5.6.11. </span>Download the load_data_CSVs<a class="headerlink" href="#download-the-load-data-csvs" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>aws s3 sync s3://<span class="si">${</span><span class="nv">BUCKET</span><span class="si">}</span>/projects/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>/workspace/load_data_csv/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span> load_data_csv/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span>
gzip -r  load_data_csv/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="download-the-metadata-files">
<h3><span class="section-number">5.6.12. </span>Download the metadata files<a class="headerlink" href="#download-the-metadata-files" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>aws s3 sync s3://<span class="si">${</span><span class="nv">BUCKET</span><span class="si">}</span>/projects/<span class="si">${</span><span class="nv">PROJECT_NAME</span><span class="si">}</span>/workspace/metadata/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span> metadata/platemaps/<span class="si">${</span><span class="nv">BATCH_ID</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="make-the-config-file">
<h3><span class="section-number">5.6.13. </span>Make the config file<a class="headerlink" href="#make-the-config-file" title="Permalink to this headline">#</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cp profiling-recipe/config_template.yml config_files/<span class="si">${</span><span class="nv">CONFIG_FILE</span><span class="si">}</span>.yml
nano config_files/<span class="si">${</span><span class="nv">CONFIG_FILE</span><span class="si">}</span>.yml
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The changes you will likely need to make for most small use cases following this handbook. For <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> set <code class="docutils literal notranslate"><span class="pre">perform</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code>, for <code class="docutils literal notranslate"><span class="pre">annotate</span></code> sub-setting <code class="docutils literal notranslate"><span class="pre">external</span></code> set <code class="docutils literal notranslate"><span class="pre">perform</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code>, in <code class="docutils literal notranslate"><span class="pre">feature_select</span></code> set <code class="docutils literal notranslate"><span class="pre">gct</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>,
and finally at the bottom set the batch(es) and plates names</p>
<p>For large batches with many DMSO wells and external metadata ala the JUMP project - set <code class="docutils literal notranslate"><span class="pre">perform</span></code> under <code class="docutils literal notranslate"><span class="pre">external</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>, set <code class="docutils literal notranslate"><span class="pre">file</span></code> to the name of the external metadata file and set <code class="docutils literal notranslate"><span class="pre">merge_column</span></code> to the name of the compound identifier column in platemap.txt and external_metadata.tsv.</p>
</div>
</section>
<section id="set-up-the-profiles">
<h3><span class="section-number">5.6.14. </span>Set up the profiles<a class="headerlink" href="#set-up-the-profiles" title="Permalink to this headline">#</a></h3>
<p>Note that the “find” step can take a few seconds/minutes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p profiles/${BATCH_ID}
find ../../backend/${BATCH_ID}/ -type f -name &quot;*.csv&quot; -exec profiling-recipe/scripts/csv2gz.py {} \;
rsync -arzv --include=&quot;*/&quot; --include=&quot;*.gz&quot; --exclude &quot;*&quot; ../../backend/${BATCH_ID}/ profiles/${BATCH_ID}/
</pre></div>
</div>
</section>
<section id="run-the-profiling-workflow">
<h3><span class="section-number">5.6.15. </span>Run the profiling workflow<a class="headerlink" href="#run-the-profiling-workflow" title="Permalink to this headline">#</a></h3>
<p>Especially for large number of plates, this will take some time.  Output will be logged to the console as different steps proceed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>python profiling-recipe/profiles/profiling_pipeline.py --config config_files/{$CONFIG_FILE}.yml
</pre></div>
</div>
</section>
<section id="push-resulting-files-back-up-to-github">
<h3><span class="section-number">5.6.16. </span>Push resulting files back up to GitHub<a class="headerlink" href="#push-resulting-files-back-up-to-github" title="Permalink to this headline">#</a></h3>
<p>If using a data repository, push the newly created profiles to DVC and the .dvc files and other files to GitHub as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dvc add profiles/${BATCH} --recursive
dvc push
git add profiles/${BATCH}/*.dvc profiles/*.gitignore
git commit -m &#39;add profiles&#39;
git add *
git commit -m &#39;add files made in profiling&#39;
git push
</pre></div>
</div>
<p>If not using DVC but using a data repository, push all new files to GitHub as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
If not using DVC but using a data repository, push all new files to GitHub as follows

```sh
git add *
git commit -m &#39;add profiles for batch _&#39;
git push
</pre></div>
</div>
</section>
<section id="push-resulting-files-up-to-s3">
<h3><span class="section-number">5.6.17. </span>Push resulting files up to S3<a class="headerlink" href="#push-resulting-files-up-to-s3" title="Permalink to this headline">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>parallel aws s3 sync {1} s3://${BUCKET}/projects/${PROJECT_NAME}/workspace/{1} ::: config_files gct profiles quality_control
</pre></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="04-run-cellprofiler.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">4. </span>Run each CellProfiler step</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="06-appendix.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Appendix</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Beth Cimini, Tim Becker, Shantanu Singh, Gregory Way, Hamdah Abbasi, Callum Tromans-Coia<br/>
  
      &copy; Copyright .<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>